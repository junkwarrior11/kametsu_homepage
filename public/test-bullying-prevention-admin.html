<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã„ã˜ã‚é˜²æ­¢ç®¡ç†ç”»é¢ - å‹•ä½œãƒ†ã‚¹ãƒˆ</title>
    <link rel="stylesheet" href="/static/css/admin.css">
    <link rel="stylesheet" href="/static/css/pdf-upload.css">
    <link rel="stylesheet" href="/static/css/image-upload.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            background: #f5f5f5;
            padding: 20px;
        }
        .test-header {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .test-section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .debug-log {
            background: #1a202c;
            color: #68d391;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }
        .debug-item {
            padding: 5px 0;
            border-bottom: 1px solid #2d3748;
        }
        .timestamp {
            color: #90cdf4;
            margin-right: 10px;
        }
        .success { color: #68d391; }
        .error { color: #fc8181; }
        .warning { color: #f6ad55; }
        .info { color: #63b3ed; }
    </style>
</head>
<body>
    <div class="test-header">
        <h1><i class="fas fa-shield-alt"></i> ã„ã˜ã‚é˜²æ­¢ç®¡ç†ç”»é¢ - å‹•ä½œãƒ†ã‚¹ãƒˆ</h1>
        <p>PDFã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ã®å‹•ä½œã‚’è©³ç´°ã«ç¢ºèªã—ã¾ã™</p>
    </div>

    <div class="test-section">
        <h2>1. ç’°å¢ƒãƒã‚§ãƒƒã‚¯</h2>
        <button class="btn-primary" onclick="checkEnvironment()">
            <i class="fas fa-check-circle"></i> ç’°å¢ƒã‚’ãƒã‚§ãƒƒã‚¯
        </button>
        <div id="envResult"></div>
    </div>

    <div class="test-section">
        <h2>2. PDFé¸æŠæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ</h2>
        <p>å®Ÿéš›ã®ç®¡ç†ç”»é¢ã¨åŒã˜æ–¹æ³•ã§PDFé¸æŠãƒœã‚¿ãƒ³ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™</p>
        
        <div class="form-group">
            <label for="pdf_url">PDFãƒ•ã‚¡ã‚¤ãƒ« <span class="required">*</span></label>
            <div class="pdf-upload-field">
                <input type="text" id="pdf_url" required placeholder="PDFã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„" readonly>
                <button type="button" class="btn-upload" onclick="openPDFPicker()">
                    <i class="fas fa-upload"></i> PDFã‚’é¸æŠ
                </button>
            </div>
            <input type="hidden" id="pdf_name">
            <input type="hidden" id="pdf_id">
            <small style="color: #666; display: block; margin-top: 8px;">PCã‹ã‚‰PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ï¼ˆæœ€å¤§10MBï¼‰</small>
        </div>

        <div style="margin-top: 20px;">
            <h3>é¸æŠã•ã‚ŒãŸå€¤:</h3>
            <div style="background: #f9f9f9; padding: 15px; border-radius: 6px; margin-top: 10px;">
                <p><strong>pdf_url:</strong> <span id="display_pdf_url" style="color: #666;">æœªé¸æŠ</span></p>
                <p><strong>pdf_name:</strong> <span id="display_pdf_name" style="color: #666;">æœªé¸æŠ</span></p>
                <p><strong>pdf_id:</strong> <span id="display_pdf_id" style="color: #666;">æœªé¸æŠ</span></p>
            </div>
        </div>
    </div>

    <div class="test-section">
        <h2>3. ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°</h2>
        <div id="debugLog" class="debug-log">
            <div class="debug-item">
                <span class="timestamp">[èµ·å‹•]</span>
                <span>ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸ã‚’åˆæœŸåŒ–ä¸­...</span>
            </div>
        </div>
    </div>

    <script src="/static/js/pdf-upload.js"></script>
    <script src="/static/js/admin-bullying-prevention.js"></script>
    <script>
        // currentPDFDataã¯admin-bullying-prevention.jsã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã®ã§å‰Šé™¤

        function addLog(message, type = 'info') {
            const log = document.getElementById('debugLog');
            const item = document.createElement('div');
            item.className = 'debug-item';
            
            const now = new Date();
            const time = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}.${String(now.getMilliseconds()).padStart(3, '0')}`;
            
            let className = 'info';
            if (type === 'success') className = 'success';
            if (type === 'error') className = 'error';
            if (type === 'warning') className = 'warning';
            
            item.innerHTML = `
                <span class="timestamp">[${time}]</span>
                <span class="${className}">${message}</span>
            `;
            log.appendChild(item);
            log.scrollTop = log.scrollHeight;
            
            console.log(`[${time}] ${message}`);
        }

        function checkEnvironment() {
            addLog('=== ç’°å¢ƒãƒã‚§ãƒƒã‚¯é–‹å§‹ ===');
            
            const checks = {
                'window.openPDFPicker': typeof window.openPDFPicker,
                'showPDFPickerModal': typeof showPDFPickerModal,
                'uploadPDF': typeof uploadPDF,
                'getUploadedPDFs': typeof getUploadedPDFs,
                'fileToBase64': typeof fileToBase64,
                'showNotification': typeof showNotification,
                'currentPDFData': typeof currentPDFData
            };
            
            let html = '<div style="margin-top: 15px; padding: 15px; background: #f9f9f9; border-radius: 6px;">';
            let allOk = true;
            
            for (const [name, type] of Object.entries(checks)) {
                const isOk = type === 'function' || type === 'object';
                allOk = allOk && isOk;
                const status = isOk ? 'âœ…' : 'âŒ';
                const color = isOk ? 'green' : 'red';
                html += `<p style="margin: 5px 0;"><strong>${name}:</strong> <span style="color: ${color}">${status} ${type}</span></p>`;
                addLog(`${name}: ${type}`, isOk ? 'success' : 'error');
            }
            
            html += '</div>';
            document.getElementById('envResult').innerHTML = html;
            
            if (allOk) {
                addLog('âœ… ã™ã¹ã¦ã®é–¢æ•°ãŒæ­£å¸¸ã«ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã™', 'success');
            } else {
                addLog('âŒ ä¸€éƒ¨ã®é–¢æ•°ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
            }
        }

        // openPDFPickeré–¢æ•°ã‚’ãƒ©ãƒƒãƒ—ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
        const originalOpenPDFPicker = window.openPDFPicker;
        if (originalOpenPDFPicker) {
            window.openPDFPicker = function() {
            addLog('ğŸ“¤ openPDFPicker() ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã—ãŸ', 'info');
            
            if (typeof showPDFPickerModal === 'undefined') {
                addLog('âŒ showPDFPickerModal ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                alert('ã‚¨ãƒ©ãƒ¼: showPDFPickerModal ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            addLog('ğŸ“‹ showPDFPickerModal() ã‚’å‘¼ã³å‡ºã—ã¾ã™...', 'info');
            
            try {
                showPDFPickerModal(function(pdfData) {
                    addLog('âœ… ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒå®Ÿè¡Œã•ã‚Œã¾ã—ãŸ', 'success');
                    addLog('ğŸ“„ PDFãƒ‡ãƒ¼ã‚¿ã‚’å—ä¿¡: ' + pdfData.file_name, 'success');
                    
                    currentPDFData = pdfData;
                    
                    if (pdfData.pdf_data) {
                        document.getElementById('pdf_url').value = pdfData.pdf_data;
                        document.getElementById('pdf_name').value = pdfData.file_name;
                        document.getElementById('pdf_id').value = pdfData.id;
                        
                        // è¡¨ç¤ºã‚’æ›´æ–°
                        document.getElementById('display_pdf_url').textContent = pdfData.pdf_data.substring(0, 50) + '...';
                        document.getElementById('display_pdf_name').textContent = pdfData.file_name;
                        document.getElementById('display_pdf_id').textContent = pdfData.id;
                        
                        addLog('âœ… ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å€¤ã‚’è¨­å®šã—ã¾ã—ãŸ', 'success');
                    }
                    
                    if (typeof showNotification === 'function') {
                        showNotification('PDFã‚’é¸æŠã—ã¾ã—ãŸ', 'success');
                        addLog('âœ… é€šçŸ¥ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ', 'success');
                    } else {
                        addLog('âš ï¸ showNotification ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'warning');
                    }
                });
                
                addLog('âœ… showPDFPickerModal() ã®å‘¼ã³å‡ºã—æˆåŠŸ', 'success');
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¡¨ç¤ºã•ã‚ŒãŸã‹ç¢ºèª
                setTimeout(() => {
                    const modal = document.querySelector('.pdf-picker-modal');
                    if (modal) {
                        addLog('âœ… PDFãƒ”ãƒƒã‚«ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸ', 'success');
                    } else {
                        addLog('âš ï¸ ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'warning');
                    }
                }, 100);
                
            } catch (error) {
                addLog('âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ: ' + error.message, 'error');
                console.error('Error in openPDFPicker:', error);
            }
            };
        } else {
            addLog('âŒ openPDFPicker ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚
        window.addEventListener('DOMContentLoaded', function() {
            addLog('âœ… DOMContentLoaded ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«', 'success');
            
            setTimeout(() => {
                checkEnvironment();
            }, 500);
        });

        // inputè¦ç´ ã®å¤‰æ›´ã‚’ç›£è¦–
        ['pdf_url', 'pdf_name', 'pdf_id'].forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('change', function() {
                    addLog(`ğŸ“ ${id} ã®å€¤ãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸ: ${this.value.substring(0, 50)}...`, 'info');
                });
            }
        });
    </script>
</body>
</html>
